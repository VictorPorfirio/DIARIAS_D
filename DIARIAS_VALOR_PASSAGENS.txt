create or replace FUNCTION  "DIARIAS_VALOR_PASSAGENS" 
(vcodigoevento in NUMBER,
vcodigoservidor in NUMBER)
return NUMBER
is
valores NUMBER;
evento number;
contagem number := 0;
--cursor Cur_valores is select distinct DB.Tarifa from diarias_bilhete db, diarias_trecho_pessoa dtp where DB.CODIGO_TRECHO_PESSOA = dtp.codigo and codigo_pessoa = vcodigoservidor;
--cursor Cur_valores is select distinct DB.Tarifa, DB.TAXA_DE_EMBARQUE, DB.RAV, DB.REQUISICAO, DB.CREDITO, DB.MULTA from diarias_bilhete db, diarias_trecho_pessoa dtp, diarias_viagem_trecho dvt, diarias_lancamento_viagem dlv
cursor Cur_valores is 
    select distinct 
    CASE WHEN DB.Tarifa is not null then DB.Tarifa
        else 0 end as Tarifa, 
    CASE WHEN DB.TAXA_DE_EMBARQUE is not null then DB.TAXA_DE_EMBARQUE
        else 0 end as Taxa_de_embarque, 
    CASE WHEN DB.RAV is not null then DB.RAV
        else 0 end as RAV, 
    CASE WHEN DB.REQUISICAO is not null then DB.REQUISICAO
        else 0 end  as Requisicao, 
    CASE WHEN DB.CREDITO is not null then DB.CREDITO
        else 0 end as Credito, 
    CASE WHEN DB.MULTA is not null then DB.MULTA
        else 0 end as Multa,
    CASE WHEN DB.OUTRAS_TAXAS is not null then DB.OUTRAS_TAXAS
        else 0 end as OUTRAS_TAXAS
    
    from diarias_bilhete db, diarias_trecho_pessoa dtp, diarias_viagem_trecho dvt, diarias_lancamento_viagem dlv, DIARIAS_BILHETE_TRECHO DBT
    where DBT.CODIGO_TRECHO_PESSOA = dtp.codigo and dtp.codigo_pessoa = vcodigoservidor
    AND dtp.codigo_trecho = dvt.codigo AND dvt.CODIGO_LANCAMENTO_VIAGEM = dlv.codigo AND dlv.codigo_evento = vcodigoevento
    AND DBT.CODIGO_BILHETE= DB.CODIGO ;
reg_valores Cur_valores%Rowtype;
begin
valores := 0;
OPEN Cur_valores;
fetch Cur_valores into reg_valores;
--valores := valores + reg_valores.tarifa;
valores := valores + reg_valores.TARIFA + reg_valores.TAXA_DE_EMBARQUE + reg_valores.RAV + reg_valores.REQUISICAO + reg_valores.MULTA - reg_valores.CREDITO + reg_valores.OUTRAS_TAXAS;
/*
SELECT codigo_evento, count(codigo_evento) into evento, contagem
    FROM DIARIAS_LANCAMENTO_VIAGEM 
    WHERE CODIGO in (select     DLV.codigo 
     from     DIARIAS_VIAGEM_TRECHO DVT,
         DIARIAS_TRECHO_PESSOA DTP,
         DIARIAS_LANCAMENTO_VIAGEM DLV,
         DIARIAS_BILHETE DB, DIARIAS_BILHETE_TRECHO DBT
         --VW_APEX_SOLICITADORES_ALL VSA,
         --diarias_evento de
     where  DLV.CODIGO_EVENTO = vcodigoevento
     and    DLV.CODIGO = DVT.CODIGO_LANCAMENTO_VIAGEM
     and    DTP.CODIGO_PESSOA = vcodigoservidor
     and    DTP.CODIGO_TRECHO = DVT.CODIGO
     and    DBT.CODIGO_TRECHO_PESSOA = dtp.codigo)
    group by codigo_evento
having count(codigo_evento) > 0;
if(contagem > 1) 
    then
    loop
        fetch Cur_valores into reg_valores;
        
        --companhias := companhias || ' / ' || reg_etickets.companhias;
        valores := valores + reg_valores.TARIFA + reg_valores.TAXA_DE_EMBARQUE + reg_valores.RAV + reg_valores.REQUISICAO + reg_valores.MULTA - reg_valores.CREDITO;
           
      exit when Cur_valores%NotFound;       
    end loop;  
end if;
*/
close Cur_valores;
return valores;
end;
