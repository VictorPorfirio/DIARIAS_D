create or replace FUNCTION  "DIARIAS_REGRA_FC_MAIOR2" (VCODIGO_evento in number, vcodigo_servidor in number,vcodlanc in number)
return VARCHAR2
 
     is
 
CURSOR PESSOACONSULTADA IS 
 SELECT  distinct td.descricao as Tipo,dl.codigo,dc.cargo, dl.cod_cargo, dl.codigo_pessoa,dl.data_inicio, 
dl.data_fim, dl.cod_autoridade_acompanhada, dl.data_inicio_efetiva, dl.data_fim_efetiva , substr(dc.cargo,4,1)   as Funcao
FROM DIARIAS_lancamento_diarias  dl, DIARIAS_TIPO_DIARIA td, diarias_cargo dc
WHERE  
    dl.codigo_evento = vcodigo_evento  and
    dl.codigo_pessoa = vcodigo_servidor and
    dc.codigo= dl.cod_cargo and
    td.codigo = dl.cod_tipo  and 
    upper(td.descricao) = 'NACIONAL' and
    upper(dl.se_diaria) ='S' and
    dl.codigo = vcodlanc ;
 
 
PESSOACONSULTADA_CUR PESSOACONSULTADA%ROWTYPE;
 
lista_matches VARCHAR(2000);
 
 l number :=0;
 a varchar2(4000);
 vinclui  boolean:=true;
 diaini date;
 diafim date;
 vdataantini date;
 vdataantfim date;
 fccomp number :=0;
 fcant number :=0;
 CODIGO_LANCAMENTO_MODIFICADO number;
TYPE diarias_tipo IS RECORD (
    vcodalterador  number,
    vfc     number :=0,
    vdiaexclui number,
    vdataini date,
    vdatafim date
  );
  
  
  TYPE  vdiarias_tipo IS TABLE OF diarias_tipo
      INDEX BY varchar2(30);
 
    vdiariastipo vdiarias_tipo; 
 
begin
 
FOR PESSOACONSULTADA_CUR IN PESSOACONSULTADA
LOOP
EXIT WHEN PESSOACONSULTADA%NOTFOUND;
DELETE FROM DIARIAS_ALTERACAO where CODIGO_LANCAMENTO_MODIFICADO = PESSOACONSULTADA_CUR.codigo;
 diaini :=PESSOACONSULTADA_CUR.data_inicio_efetiva;
 diafim :=PESSOACONSULTADA_CUR.data_fim_efetiva;  
 CODIGO_LANCAMENTO_MODIFICADO  :=PESSOACONSULTADA_CUR.codigo;
IF LENGTH(TRIM(TRANSLATE(PESSOACONSULTADA_CUR.funcao, 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ', ' '))) > 0 THEN
    fccomp := TO_NUMBER(PESSOACONSULTADA_CUR.funcao) +10;
   
ELSE
   fccomp := 0;
END IF;
IF fccomp = 0 THEN
    CASE PESSOACONSULTADA_CUR.CARGO
      WHEN 'AUFC' THEN fccomp := 3;
      WHEN 'TEFC' THEN fccomp := 2;
      WHEN 'AUCE' THEN fccomp := 1;
    end case ;
END IF;    
--htp.p('fc:' ||fccomp);
 end loop;
  for i in
  (
   SELECT dl.codigo, dl.cod_cargo,dc.cargo,
    substr(dc.cargo,4,1)   as Funcao,
   dl.codigo_pessoa, dl.data_inicio,dl.data_inicio_efetiva, dl.data_fim_efetiva, dl.data_fim,dl.cod_autoridade_acompanhada, dl.codigo_evento
  FROM DIARIAS_lancamento_diarias  dl,  DIARIAS_TIPO_DIARIA td,  diarias_cargo dc
  WHERE  
    dl.codigo_evento = vcodigo_evento  and
    dl.codigo_pessoa not in(vcodigo_servidor) and
    td.codigo = dl.cod_tipo and 
    upper(td.descricao) = 'NACIONAL' and
     dc.codigo = dl.cod_cargo and
    ( 
    dl.data_inicio_efetiva between  diaini and diafim and
    dl.data_fim_efetiva between  diaini and diafim 
    OR
     dl.data_inicio_efetiva <= diaini AND dl.data_fim_efetiva >=diafim
    
     )  
      and  
    upper(trim( dc.cargo )) in ('FC-1','FC-2','FC-3','FC-4','FC-5','FC-6','AUFC','TEFC','AUCE') 
    
 
      order by  3 desc, dl.data_inicio, dl.data_fim  
  
     )
    
   loop
     
    vdiariastipo(i.cargo).vdataini := i.data_inicio_efetiva;
    vdiariastipo(i.cargo).vdatafim := i.data_fim_efetiva;
    vdiariastipo(i.cargo).vcodalterador :=i.codigo;
    IF LENGTH(TRIM(TRANSLATE(I.funcao, 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ', ' '))) > 0 THEN
        vdiariastipo(i.cargo).vfc := to_number(i.funcao) +10;
    ELSE
        vdiariastipo(i.cargo).vfc := 0;
     END IF;
if  vdiariastipo(i.cargo).vfc =0 then
    CASE  i.cargo
      WHEN 'AUFC' THEN vdiariastipo(i.cargo).vfc := 3;
      WHEN 'TEFC' THEN vdiariastipo(i.cargo).vfc := 2;
      WHEN 'AUCE' THEN vdiariastipo(i.cargo).vfc := 1;
    end case ;
  end if;
   
end loop ;
    
a := vdiariastipo.last;
while a is not null loop
   
  if l=0 then 
   
  if TO_NUMBER(fccomp) <  TO_NUMBER(vdiariastipo(a).vfc) then
         if  vdiariastipo(a).vdataini <=diaini  and  vdiariastipo(a).vdatafim>=diafim then
            
             insert into DIARIAS_ALTERACAO(CODIGO_LANCAMENTO_MODIFICADOR,CODIGO_LANCAMENTO_MODIFICADO,DATA_INICIO,DATA_FIM) 
             VALUES (vdiariastipo(a).vcodalterador,CODIGO_LANCAMENTO_MODIFICADO,diaini,diafim ); 
             vdataantini := diaini;
             vdataantfim :=diafim;
             fcant :=vdiariastipo(a).vfc;
          else
              
             if  vdiariastipo(a).vdataini <=diaini  and  vdiariastipo(a).vdatafim<=diafim then
                  insert into DIARIAS_ALTERACAO(CODIGO_LANCAMENTO_MODIFICADOR,CODIGO_LANCAMENTO_MODIFICADO,DATA_INICIO,DATA_FIM) 
                 VALUES (vdiariastipo(a).vcodalterador,CODIGO_LANCAMENTO_MODIFICADO,vdiariastipo(a).vdataini, vdiariastipo(a).vdatafim); 
                  vdataantini := vdiariastipo(a).vdataini;
                 vdataantfim :=vdiariastipo(a).vdatafim;
                 fcant :=vdiariastipo(a).vfc; 
             ELSE
               
                insert into DIARIAS_ALTERACAO(CODIGO_LANCAMENTO_MODIFICADOR,CODIGO_LANCAMENTO_MODIFICADO,DATA_INICIO,DATA_FIM) 
                VALUES (vdiariastipo(a).vcodalterador,CODIGO_LANCAMENTO_MODIFICADO,vdiariastipo(a).vdataini, vdiariastipo(a).vdatafim); 
                vdataantini := vdiariastipo(a).vdataini;
                 vdataantfim :=vdiariastipo(a).vdatafim; 
                 fcant :=vdiariastipo(a).vfc;
             END IF;
          end if;
         
      END IF;
   else
        
       if TO_NUMBER(fccomp) <  TO_NUMBER(vdiariastipo(a).vfc) then
           
             IF vdataantini IS NULL THEN 
                 vdataantini := diaini;
                 vdataantfim :=diafim;
             end if;
            if vdiariastipo(a).vdataini <= vdataantini  then
                 
                if  vdiariastipo(a).vdatafim  <  vdataantini then -- vdataantfim then
                  
                  insert into DIARIAS_ALTERACAO(CODIGO_LANCAMENTO_MODIFICADOR,CODIGO_LANCAMENTO_MODIFICADO,DATA_INICIO,DATA_FIM) 
                    VALUES (vdiariastipo(a).vcodalterador,CODIGO_LANCAMENTO_MODIFICADO,vdiariastipo(a).vdataini, vdiariastipo(a).vdatafim); 
                    vdataantini := vdiariastipo(a).vdataini;
                   vdataantfim :=vdiariastipo(a).vdatafim;
                 else
                    if  vdataantfim < vdiariastipo(a).vdatafim and fcant < vdiariastipo(a).vfc then
                        insert into DIARIAS_ALTERACAO(CODIGO_LANCAMENTO_MODIFICADOR,CODIGO_LANCAMENTO_MODIFICADO,DATA_INICIO,DATA_FIM) 
                        VALUES (vdiariastipo(a).vcodalterador,CODIGO_LANCAMENTO_MODIFICADO,vdiariastipo(a).vdataini, vdiariastipo(a).vdatafim ); 
                        vdataantini := vdiariastipo(a).vdatafim ;
                        vdataantfim :=vdiariastipo(a).vdatafim  ;
                        
                     else    
                       insert into DIARIAS_ALTERACAO(CODIGO_LANCAMENTO_MODIFICADOR,CODIGO_LANCAMENTO_MODIFICADO,DATA_INICIO,DATA_FIM) 
                       VALUES (vdiariastipo(a).vcodalterador,CODIGO_LANCAMENTO_MODIFICADO,vdiariastipo(a).vdataini, vdiariastipo(a).vdatafim); 
                         vdataantini := vdiariastipo(a).vdataini;
                         vdataantfim :=vdiariastipo(a).vdatafim;
                      
                      end if;
                end if;
             else
                if vdiariastipo(a).vdataini > vdataantfim  then
                  
   
                  insert into DIARIAS_ALTERACAO(CODIGO_LANCAMENTO_MODIFICADOR,CODIGO_LANCAMENTO_MODIFICADO,DATA_INICIO,DATA_FIM) 
                    VALUES (vdiariastipo(a).vcodalterador,CODIGO_LANCAMENTO_MODIFICADO,vdiariastipo(a).vdataini, vdiariastipo(a).vdatafim); 
                    vdataantini := vdiariastipo(a).vdataini;
                   vdataantfim :=vdiariastipo(a).vdatafim;
                 else
                     
                    if vdiariastipo(a).vdataini > vdataantini  and  vdiariastipo(a).vdataini  > vdataantfim then
                     
                     insert into DIARIAS_ALTERACAO(CODIGO_LANCAMENTO_MODIFICADOR,CODIGO_LANCAMENTO_MODIFICADO,DATA_INICIO,DATA_FIM) 
                     VALUES (vdiariastipo(a).vcodalterador,CODIGO_LANCAMENTO_MODIFICADO,vdataantfim + 1, vdiariastipo(a).vdatafim); 
                     vdataantini := vdiariastipo(a).vdataini;
                     vdataantfim :=vdiariastipo(a).vdatafim;  
                    end if;
                end if;  
                 
            end if;
        end if;      
   end if;
       
   
    l:= l+1;
    a := vdiariastipo.prior(a);
        
end loop;    
 return 'ok';
end;
